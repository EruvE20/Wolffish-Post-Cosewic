---
title: "Atlantic Wolffish Post-COSEWIC Assessment"
authors: "Elizabetha Tsitrin, Kayla Silver, Daphne Themelis"
date: "`r format(Sys.Date(), format='%B %d %Y')`"  
---
  
**Purpose:** Provide an assessment of Atlantic Wolffish population trends in the Maritimes Region (Scotian Shelf) to inform the existing Recovery Strategy and Management Plan, and help guide future management actions and prioritize conservation measures. Externally, this information could support the next re-assessment of the species by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC).

**Background:** Atlantic Wolffish (*Anarhichas lupus*) underwent steep declines in both abundance and area of occupancy over much of its range from the 1980s until the mid 1990s. The species has been designated as Special Concern since 2000, with a re-evaluation in 2012 confirming the status. Research vessel surveys (NAFO areas 4X & 4VW) suggest that abundance continued to decline on the Scotian Shelf in the 2000s and remains at low levels. However, numerous factors make it difficult to confidently assess trends within the population. Using a combination of Fisheries Observer data, industry data, and Canadian Research Survey data, this review summarizes the current state of knowledge on the Atlantic Wolffish population trends in the Maritimes Region.

**Request for Science Advice:** Is it possible to develop a reliable biomass index for the Scotian Shelf portion of the population? Can the index be used to understand population trends over time? Can the index be used to assess and track fishing mortality over time? What does the data reveal about species distribution patterns? What does the data reveal about potential drivers of population decline, range shifts, and/or sustained low abundances?


```{r, echo=F, warning=F, message=F}
knitr::opts_chunk$set(echo = F, message=F, warning=F, error = F, prompt = F, results='asis')
```

```{r, include = FALSE}
#library(Mar.datawrangling)
library(tidyverse)
library(ggplot2)
library(readr)
library(rosettafish)
library(tibble)
library(csasdown)
library(gridExtra)
library(sp)
library(rgdal)
library(mapdata)
library(marmap)
library(maptools)
library(ggpubr)
library(zoo)
library(broom)

# RV Database -------------------------------------------------------------
# import and clean data 
spring4VsW <- read.csv("spring4VsW.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4VsW_lengths <- read.csv("spring4VsW_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
spring4VsW_null <- read.csv("spring4VsW_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
spring4X <- read.csv("spring4X.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4x_lengths <- read.csv("spring4x_lengths.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4X_null <- read.csv("spring4X_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
georges <- read.csv("georges.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
georges_lengths <- read.csv("georges_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
georges_null <- read.csv("georges_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
spring <- read.csv("spring.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
spring_lengths <- read.csv("spring_lengths.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
spring_null <- read.csv("spring_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
summer <- read.csv("summer.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
summer_lengths <- read.csv("summer_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
summer_null <- read.csv("summer_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
fall <- read.csv("fall.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
fall_lengths <- read.csv("fall_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
fall_null <- read.csv("fall_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
redfish <- read.csv("redfish.csv", header = T) %>%
  select(-X)
redfish_lengths <- read.csv("redfish_lengths.csv", header = T) %>% 
  select(-X)
redfish_null <- read.csv("redfish_null.csv", header = T) %>% 
  select(-X)

# ISDB Database -------------------------------------------------------------
isdb <- read.csv(file.path("data","isdb.csv")) %>%
  select(-X)
isdb_lengths <- read.csv(file.path("data","isdb_lengths.csv")) %>%
  select(-X)
isdb_null <- read.csv(file.path("data","isdb_null.csv")) %>%
  select(-X)



#Halibut Industry Longline Survey
halibut_longline <- isdb %>% filter(TRIPCD_ID == 7057)%>% 
  filter(SETCD_ID == 4)

#4VSW Sentinel Survey
sentinel <- isdb %>% filter(TRIPCD_ID == 7050)%>% 
  filter(SETCD_ID == 5)

#ITQ
ITQ <- isdb %>% filter(TRIPCD_ID == 7051) %>% 
  filter(SETCD_ID == 4)

#LOBSTER
lobster <- isdb %>% filter(TRIPCD_ID == 7065)

#combine
lobQ <- rbind(ITQ, lobster)

#SNOWCRAB
snowcrab <- isdb %>% filter(TRIPCD_ID == 7061) %>% 
  filter(SETCD_ID == 4)


#NULL SURVEYS
#Halibut Industry Longline Survey
halibut_longline_null <- isdb_null %>% filter(TRIPCD_ID == 7057)%>% 
  filter(SETCD_ID == 4)

#4VSW Setinel Survey
sentinel_null <- isdb_null %>% filter(TRIPCD_ID == 7050)%>% 
  filter(SETCD_ID == 5)

#ITQ
ITQ_null <- isdb_null %>% filter(TRIPCD_ID == 7051)%>% 
  filter(SETCD_ID == 4)

#LOBSTER
lobster_null <- isdb_null %>% filter(TRIPCD_ID == 7065)%>% 
  filter(SETCD_ID == 4)

#combine
lobQ_null <- rbind(ITQ_null, lobster_null)

#SNOWCRAB
snowcrab_null <- isdb_null %>% filter(TRIPCD_ID == 7061)%>% 
  filter(SETCD_ID == 4)


# Landings Data -------------------------------------------------------------
landings <- read.csv(file.path("data","landings.csv")) %>%
  select(-X)

# Spatial Data --------------------------------------------------------------
summerstrat <- rgdal::readOGR(file.path("data",dsn="MaritimesRegionEcosystemAssessmentStrata(2014-).shp"))
codstrat <- rgdal::readOGR(file.path("data",dsn="4VsW.shp"))
NAFODivisions <- rgdal::readOGR(file.path("data",dsn="Divisions.shp"))
NAFODivisions <- spTransform(NAFODivisions,CRS("+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"))

FortNAFO <- fortify(NAFODivisions)
FORTsummerstrat <- fortify(summerstrat)
FORTcodstrat <- fortify(codstrat)

states <- map_data("state")
usa <- subset(states)
canada <- map_data("worldHires", "Canada")

bathy <- getNOAA.bathy(-50, -80, 35, 48, resolution=1, antimeridian = F, keep=T)
```



# Methods

```{r NAFdivisions, message = FALSE, fig.pos="H", fig.cap = "NAFO Divisions examined in this document."}
idList <- NAFODivisions@data$ZONE
centroids.df <- as.data.frame(coordinates(NAFODivisions))
names(centroids.df) <- c("Longitude", "Latitude") 

df <- data.frame(id = idList, centroids.df) %>% 
  filter(id%in%c("4X", "4Vn", "4Vs", "4W", "5Ze"))

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.1,fill=NA,col="black")+
  geom_text(data=df, aes(label = id, x = Longitude, y = Latitude), size=5, fontface = "bold") + 
  coord_sf(xlim = c(-69, -55), ylim = c(39, 47.5), expand = FALSE)+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9))
```


```{r Surveydivisions, message = FALSE, fig.pos="H", message=FALSE, fig.cap = "Survey strata used during the Summer RV survey (top panel) and the winter Georges Bank survey (bottom panel).", fig.asp=1}
idList <- summerstrat@data$StrataID
centroids.df <- as.data.frame(coordinates(summerstrat))
names(centroids.df) <- c("Longitude", "Latitude") 

df <- data.frame(id = idList, centroids.df) %>% 
  filter(id%in%c(440:495))

a  <- ggplot(canada)+
  geom_polygon(aes(long, lat, group=group), fill="lightgrey", col="black")+
  geom_polygon(data=summerstrat, aes(long, lat, group = group), size=0.7, fill=NA, col="lightblue")+
  geom_text(data=df, aes(label = id, x = Longitude, y = Latitude), size=2.5, fontface = "bold") + 
  coord_sf(xlim = c(-69, -56), ylim = c(41.5, 47.5), expand = FALSE)+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9))


# idList <- codstrat@data$StrataID
# centroids.df <- as.data.frame(coordinates(codstrat))
# names(centroids.df) <- c("Longitude", "Latitude") 
# 
# df <- data.frame(id = idList, centroids.df)

# b <- ggplot(canada)+
#   geom_polygon(aes(long, lat, group=group), fill="lightgrey", col="black")+
#   geom_polygon(data=codstrat, aes(long, lat, group = group), size=0.7, fill=NA, col="lightblue")+
#   geom_text(data=df, aes(label = id, x = Longitude, y = Latitude), size=3, fontface = "bold") + 
#   coord_sf(xlim = c(-63.5, -56), ylim = c(42.5, 46), expand = FALSE)+
#   theme_bw()+
#   labs(x = "Latitude", y = "Longitude")+
#   theme(axis.title.x = element_blank())
# 
# 
idList <- summerstrat@data$StrataID
centroids.df <- as.data.frame(coordinates(summerstrat))
names(centroids.df) <- c("Longitude", "Latitude")


df <- data.frame(id = idList, centroids.df) %>%
  filter(id%in%c("5Z1","5Z2","5Z31","5Z32","5Z33","5Z34","5Z41","5Z42","5Z5","5Z6","5Z7","5Z8","5Z9")) %>%
  mutate(id = case_when(id=="5Z31" ~ "5Z3",
                        id=="5Z32" ~ "5Z3",
                        id=="5Z33" ~ "5Z3",
                        id=="5Z34" ~ "5Z3",
                        id=="5Z41" ~ "5Z4",
                        id=="5Z42" ~ "5Z4",
                        TRUE ~ id)) %>%
  group_by(id) %>%
  summarise(Longitude = mean(Longitude),
            Latitude = mean(Latitude))

b <- ggplot(usa)+
  geom_polygon(aes(long, lat, group=group), fill="lightgrey", col="black")+
  geom_polygon(data=summerstrat, aes(long, lat, group = group), size=0.7, fill=NA, col="lightblue")+
  geom_text(data=df, aes(label = id, x = Longitude, y = Latitude), size=3, fontface = "bold") + 
  coord_sf(xlim = c(-71, -65.5), ylim = c(40, 42.5), expand = FALSE)+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9))

gridExtra::grid.arrange(a,b, nrow = 2)
```



### Summer Survey of the Scotian Shelf (Divs. 4VWX)
```{r summer1, message = FALSE, warning=FALSE, fig.cap=""}
#remove years 2018 and 2021 due to incomplete data coverage
summer_null <- summer_null %>%
  filter(!YEAR %in% c(2018, 2021)) %>%
  filter(STRAT%in%(440:495))

summer <- summer %>%
  filter(!YEAR %in% c(2018, 2021))%>%
  filter(STRAT%in%(440:495))

summer_lengths <- summer_lengths %>%
  filter(!YEAR %in% c(2018, 2021))%>%
  filter(STRAT%in%(440:495))


#distribution by size
immature_a <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN <= 53) %>%
  filter(YEAR < 2011) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
immature_a <- as.data.frame(immature_a)

immature_b <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN <= 53) %>%
  filter(YEAR > 2010) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
immature_b <- as.data.frame(immature_b)

mature_a <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN > 53) %>%
  filter(YEAR < 2011) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
mature_a <- as.data.frame(mature_a)

mature_b <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN > 53) %>%
  filter(YEAR > 2010) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
mature_b <- as.data.frame(mature_b)

null_a <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR < 2011) %>%
  filter(CODE != 50)

null_b <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR > 2010) %>%
  filter(CODE != 50)

immature_a <- Mar.utils::aggregator(immature_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
immature_b <- Mar.utils::aggregator(immature_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
mature_a <- Mar.utils::aggregator(mature_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
mature_b <- Mar.utils::aggregator(mature_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
null_a <- Mar.utils::aggregator(null_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
null_b <- Mar.utils::aggregator(null_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)


immature_a$maturity <- "immature"
immature_b$maturity <- "immature"
immature_a$yr <- "1970-2010"
immature_b$yr <- "2011-2020"

mature_a$maturity <- "mature"
mature_b$maturity <- "mature"
mature_a$yr <- "1970-2010"
mature_b$yr <- "2011-2020"

null_a$yr <- "1970-2010"
null_b$yr <- "2011-2020"

df <- rbind(immature_a, immature_b, mature_a, mature_b)
null <- rbind(null_a, null_b)


autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  scale_size_continuous(breaks = c(5,10,50,100,150,200))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Number at length")+
  facet_grid(yr~maturity)
```

```{r summer2, message = FALSE, warning=FALSE, fig.cap="", fig.asp=1}
a <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR < 2011) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

b <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR > 2010) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

a <- Mar.utils::aggregator(a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
b <- Mar.utils::aggregator(b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)

a$yr <- "1970-2010"
b$yr <- "2011-2020"
df <- rbind(a,b)

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  scale_size_continuous(limits = c(0,300), breaks=c(5,10,50,100,150,200,250,300))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")+
  facet_wrap(~yr, ncol=1)
```

```{r summer3, message = FALSE, warning=FALSE, fig.cap=""}
a <- read.csv("4VW.csv")
b <- read.csv("4X.csv")
VW <- rbind(a,b)

VW$biomass <- VW$biomass*0.001
VW <- VW %>% mutate(group = ifelse(YEAR <1982, 1, 2))

VW_means <- VW %>%
  mutate(immature_mean=rollmean(immature, 3,na.pad = T))%>%
  mutate(mature_mean=rollmean(mature, 3,na.pad = T)) %>%
  select(immature_mean, mature_mean)

VW <- VW %>% pivot_longer(immature:mature, names_to = "maturity", values_to = "abundance")
VW_means <- VW_means %>% pivot_longer(immature_mean:mature_mean, names_to = "mat2", values_to = "rollmean")

VW <- cbind(VW,VW_means) %>%
  select(-mat2)

VW %>%
  group_by(YEAR, maturity) %>%
  summarise(abundance=sum(abundance),
            mean=sum(rollmean),
            group=group) %>%
  ggplot()+
  geom_point(aes(x=YEAR, y=abundance, shape=maturity))+
  geom_line(aes(x=YEAR, y=abundance, group=interaction(maturity, group)))+
  geom_point(aes(x=YEAR, y=mean, shape=maturity, col=maturity), size=2.5)+
  geom_line(aes(x=YEAR, y=mean, col=maturity, group=interaction(maturity, group)), size=1)+
  scale_colour_manual(values = c("#00D712", "blue"))+
  theme_bw()+
  scale_y_continuous(labels=scales::comma)+
  labs(y = "Number at Length")+
  geom_vline(xintercept = 1981, col="red", linetype="dashed")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))
```

```{r summer4, message = FALSE, warning=FALSE, fig.cap="", fig.asp=1}
strat <- summer_null %>%
  filter(STRAT %in%(440:495)) %>%
  group_by(YEAR, STRAT) %>%
  summarize(numsets = length(unique(SETNO)))

catch <- summer_null %>%
  filter(STRAT %in%(440:495)) %>%
  filter(CODE == 50) %>%
  group_by(YEAR, STRAT) %>%
  summarize(wolfsets = length(unique(SETNO)))

area <- summer_null %>%
  filter(STRAT %in%(440:495)) %>%
  group_by(STRAT) %>%
  distinct(AREA.GSSTRATUM) %>%
  mutate(swept = AREA.GSSTRATUM/0.0118006)

area <- strat %>% left_join(area, by="STRAT") %>%
  left_join(catch, by=c("YEAR","STRAT")) %>%
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>%
  replace(is.na(.), 0) %>%
  group_by(YEAR) %>%
  summarise(total_area = sum(AREA.GSSTRATUM),
                             area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100) %>%
  mutate(group = ifelse(YEAR <1982, 1, 2))


a <- VW %>%
  group_by(YEAR, region) %>%
  distinct(biomass, group) %>%
  group_by(YEAR) %>%
  summarise(biomass=sum(biomass)) %>%
  mutate(group = ifelse(YEAR <1982, 1, 2)) %>%
  ggplot(aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(aes(group=group))+
  geom_point(aes(y=rollmean(biomass, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(group=group, y=rollmean(biomass, 3, na.pad = T)),
            col="blue", size=1)+
  theme_bw()+
  labs(y = "Biomass(t)")+
  geom_vline(xintercept = 1981, col="red", linetype="dashed")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))

b <- ggplot(area, aes(x=YEAR, y=area_occupied))+
  geom_point()+
  geom_line(aes(group=group), alpha=0.3)+
  geom_point(aes(y=rollmean(area_occupied, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(group=group, y=rollmean(area_occupied, 3, na.pad = T)),
            col="blue", size=1)+
  geom_vline(xintercept = 1981, col="red", linetype="dashed")+
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = "Stratified Area Occupied")

cowplot::plot_grid(a, b, align="v", ncol=1)
```

```{r summer5, message = FALSE, warning=FALSE, fig.cap=""}
len_sum <- read.csv("Summer_strat_len.csv")

str(len_sum)
len_sum$length <- as.numeric(len_sum$length)

ggplot(len_sum, aes(x=length, y=n))+
  geom_bar(stat="identity")+
  theme_bw()+
  scale_y_continuous(labels=scales::comma)+
  theme(axis.text = element_text(size=10),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = "Number at length", x="Length (cm)")
```



### Seasonal variability in 4VW
```{r spring4vsW,message = FALSE, warning=FALSE, fig.cap=""}
a <- spring4VsW_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

null <- spring4VsW_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(CODE != 50)

a <- Mar.utils::aggregator(a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)


autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-64, -56), ylim = c(42, 46.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=a, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  scale_size_continuous(limits = c(1, 30), breaks=c(5,10,15,20,25,30))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")
```

```{r spring4VWX,message = FALSE, warning=FALSE, fig.cap=""}
a <- spring_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

null <- spring_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(CODE != 50)

a <- Mar.utils::aggregator(a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)


autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=a, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  scale_size_continuous(limits = c(1, 120), breaks=c(20,40,60,80,100,120))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")
```

```{r spring4X,message = FALSE, warning=FALSE, fig.cap=""}
a <- spring4X_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

null <- spring4X_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(CODE != 50)

a <- Mar.utils::aggregator(a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)


autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -62), ylim = c(41.5, 46), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=a, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")
```


### Winter Survey of Georges Bank (Div. 5Ze)
```{r georges1,message = FALSE, warning=FALSE, fig.cap=""}
#distribution by size
immature_a <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN <= 53) %>%
  filter(YEAR < 2011) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
immature_a <- as.data.frame(immature_a)

immature_b <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN <= 53) %>%
  filter(YEAR > 2010) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
immature_b <- as.data.frame(immature_b)

mature_a <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN > 53) %>%
  filter(YEAR < 2011) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
mature_a <- as.data.frame(mature_a)

mature_b <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN, YEAR) %>%
  filter(FLEN > 53) %>%
  filter(YEAR > 2010) %>%
  group_by(MISSION, SETNO) %>%
  mutate(count = length(FLEN)) %>%
  ungroup() %>%
  select(-FLEN) %>%
  distinct(MISSION, SETNO, .keep_all=T)
mature_b <- as.data.frame(mature_b)

null_a <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR < 2011) %>%
  filter(CODE != 50)

null_b <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR > 2010) %>%
  filter(CODE != 50)

immature_a <- Mar.utils::aggregator(immature_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
immature_b <- Mar.utils::aggregator(immature_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
mature_a <- Mar.utils::aggregator(mature_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
mature_b <- Mar.utils::aggregator(mature_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15)
null_a <- Mar.utils::aggregator(null_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
null_b <- Mar.utils::aggregator(null_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)


immature_a$maturity <- "immature"
immature_b$maturity <- "immature"
immature_a$yr <- "1987-2010"
immature_b$yr <- "2011-2020"

mature_a$maturity <- "mature"
mature_b$maturity <- "mature"
mature_a$yr <- "1987-2010"
mature_b$yr <- "2011-2020"

null_a$yr <- "1987-2010"
null_b$yr <- "2011-2020"

df <- rbind(immature_a, immature_b, mature_a, mature_b)
null <- rbind(null_a, null_b)


autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-70.5, -65.5), ylim = c(39.5, 42.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  scale_size_continuous(breaks = c(1,5,10,20,30,40,50))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Number at length")+
  facet_grid(yr~maturity)
```

```{r georges2,message = FALSE, warning=FALSE, fig.cap="", fig.asp=1}
a <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR < 2011) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

b <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>%
  filter(YEAR > 2010) %>%
  filter(TOTWGT > 0) %>%
  filter(CODE == 50)

a <- Mar.utils::aggregator(a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)
b <- Mar.utils::aggregator(b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)

a$yr <- "1987-2010"
b$yr <- "2011-2020"
df <- rbind(a,b)

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-70.5, -65.5), ylim = c(39.5, 42.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  scale_size_continuous(limits = c(0,300), breaks=c(5,10,50,100,250,500))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")+
  facet_wrap(~yr, ncol=1)
```

```{r georges3,message = FALSE, warning=FALSE, fig.cap=""}
George <- read.csv("Georges.csv")

George$biomass <- George$biomass*0.001

George_total <- George %>%
  group_by(YEAR) %>%
  summarise(immature = sum(immature),
            mature=sum(mature),
            biomass=sum(biomass))

George_means <- George %>%
  mutate(immature_mean=rollmean(immature, 3,na.pad = T))%>%
  mutate(mature_mean=rollmean(mature, 3,na.pad = T)) %>%
  select(immature_mean, mature_mean)

George <- George %>% pivot_longer(immature:mature, names_to = "maturity", values_to = "abundance")
George_means <- George_means %>% pivot_longer(immature_mean:mature_mean, names_to = "mat2", values_to = "rollmean")

George <- cbind(George,George_means) %>%
  select(-mat2)

George %>%
  group_by(YEAR, maturity) %>%
  summarise(abundance=sum(abundance),
            mean=sum(rollmean)) %>%
  ggplot()+
  geom_point(aes(x=YEAR, y=abundance, shape=maturity))+
  geom_line(aes(x=YEAR, y=abundance, group=maturity))+
  geom_point(aes(x=YEAR, y=mean, shape=maturity, col=maturity), size=2.5)+
  geom_line(aes(x=YEAR, y=mean, col=maturity, group=maturity), size=1)+
  scale_colour_manual(values = c("#00D712", "blue"))+
  theme_bw()+
  scale_y_continuous(labels=scales::comma)+
  labs(y = "Number at Length")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))
```

```{r georges4,message = FALSE, warning=FALSE, fig.cap="", fig.asp=1}
strat <- georges_null %>%
  filter(STRAT %in%c("5Z1", "5Z2")) %>%
  group_by(YEAR, STRAT) %>%
  summarize(numsets = length(unique(SETNO)))

catch <- georges_null %>%
  filter(STRAT %in%c("5Z1", "5Z2")) %>%
  filter(CODE == 50) %>%
  group_by(YEAR, STRAT) %>%
  summarize(wolfsets = length(unique(SETNO)))

area <- georges_null %>%
  filter(STRAT %in%c("5Z1", "5Z2")) %>%
  group_by(STRAT) %>%
  distinct(AREA.GSSTRATUM) %>%
  mutate(swept = AREA.GSSTRATUM/0.0118006)

area <- strat %>% left_join(area, by="STRAT") %>%
  left_join(catch, by=c("YEAR","STRAT")) %>%
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>%
  replace(is.na(.), 0) %>%
  group_by(YEAR) %>%
  summarise(total_area = sum(AREA.GSSTRATUM),
                             area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100)


a <- George %>%
  group_by(YEAR) %>%
  distinct(biomass) %>% 
  ggplot(aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(alpha=0.3)+
  geom_point(aes(y=rollmean(biomass, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes( y=rollmean(biomass, 3, na.pad = T)),
            col="blue", size=1)+
  theme_bw()+
  labs(y = "Biomass(t)")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))

b <- ggplot(area, aes(x=YEAR, y=area_occupied))+
  geom_point()+
  geom_line(alpha=0.3)+
  geom_point(aes(y=rollmean(area_occupied, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(area_occupied, 3, na.pad = T)),
            col="blue", size=1)+
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = "Stratified Area Occupied")

cowplot::plot_grid(a, b, align="v", ncol=1)
```

```{r georges5, message = FALSE, warning=FALSE, fig.cap=""}
len_sum <- read.csv("Georges_strat_len.csv")

str(len_sum)
len_sum$length <- as.numeric(len_sum$length)

ggplot(len_sum, aes(x=length, y=n))+
  geom_bar(stat="identity")+
  theme_bw()+
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks=c(0,25,50,75,100,125))+
  theme(axis.text = element_text(size=10),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = "Number at length", x="Length (cm)")
```


## Canadian Industry Surveys 

### Halibut Longline Survey (Divs. 4VWX)

```{r halibut-dist, message = FALSE, warning=FALSE, fig.cap="Distribution of Atlantic wolffish catches in the Halibut Longline Survey on the Scotian Shelf (Divs. 4VWX), 1998-2021, summed by 15 minute aggregation.", fig.asp=1}
a <- halibut_longline_null%>%
  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>%
  filter(YEAR < 2011) %>%
  filter(EST_COMBINED_WT > 0) %>%
  filter(SPECCD_ID == 50) %>%
  filter(grepl("^4|^5", NAFAREA_ID ))

b <- halibut_longline_null%>%
  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>%
  filter(YEAR > 2010) %>%
  filter(EST_COMBINED_WT > 0) %>%
  filter(SPECCD_ID == 50) %>%
  filter(grepl("^4|^5", NAFAREA_ID ))

null_a <- halibut_longline_null%>%
  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>%
  filter(YEAR < 2011) %>%
  filter(SPECCD_ID != 50) %>%
  filter(grepl("^4|^5", NAFAREA_ID ))

null_b <- halibut_longline_null%>%
  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>%
  filter(YEAR > 2010) %>%
  filter(SPECCD_ID != 50) %>%
  filter(grepl("^4|^5", NAFAREA_ID ))


a <- Mar.utils::aggregator(a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
b <- Mar.utils::aggregator(b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
null_a <- Mar.utils::aggregator(null_a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
null_b <- Mar.utils::aggregator(null_b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)


a$yr <- "1998-2010"
b$yr <- "2011-2020"
df <- rbind(a,b)

null_a$yr <- "1998-2010"
null_b$yr <- "2011-2020"
null <- rbind(null_a, null_b)

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  scale_size_continuous(limits = c(0,300), breaks=c(5,40,80,120,160))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")+
  facet_wrap(~yr, ncol=1)
```

```{r halibut-catch, message = FALSE, warning=FALSE, fig.cap="Mean catch per 1000 hooks of Atlantic wolffish in the Halibut Longline Survey on the Scotian Shelf (Divs. 4VWX), 1998-2021."}
cpue <- halibut_longline %>% 
  select(YEAR, EST_COMBINED_WT, NUM_HOOK_HAUL) %>% 
  mutate(catch = (EST_COMBINED_WT/NUM_HOOK_HAUL)*1000) %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(catch))
  
ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line(alpha=0.3)+
  theme_bw()+
  geom_point(aes(y=rollmean(CPUE, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(CPUE, 3, na.pad = T)),
            col="blue")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = 'Mean catch (kg) per 1000 hooks')
```


### Sentinel Longline Survey (Divs. 4VsW)

```{r senti-dist, message = FALSE, warning=FALSE, fig.cap="Distribution of Atlantic wolffish catches in the 4VSW Sentinel Survey, 1996-2020, summed by 15 minute aggregation.", fig.asp=1}
a <-sentinel_null %>% select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(YEAR < 2011) %>%
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)
b <-sentinel_null %>% select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(YEAR > 2010) %>%
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)
null_a <- sentinel_null %>%  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(YEAR < 2011) %>%
  filter(SPECCD_ID != 50)
null_b <- sentinel_null %>%  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(YEAR > 2010) %>%
  filter(SPECCD_ID != 50)

a <- Mar.utils::aggregator(a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
b <- Mar.utils::aggregator(b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
null_a <- Mar.utils::aggregator(null_a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
null_b <- Mar.utils::aggregator(null_b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)


a$yr <- "1996-2010"
b$yr <- "2011-2020"
df <- rbind(a,b)

null_a$yr <- "1996-2010"
null_b$yr <- "2011-2020"
null <- rbind(null_a, null_b)

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-64, -57), ylim = c(42.5, 46), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  scale_size_continuous( breaks=c(5,50,100,150))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")+
  facet_wrap(~yr, ncol=1)
```

```{r senti-catch, message = FALSE, warning=FALSE, fig.cap="Mean catch per 1000 hooks of Atlantic wolffish in the 4VSW Sentinel Survey, 1996-2020."}
cpue <- sentinel %>% 
  select(YEAR, EST_COMBINED_WT, NUM_HOOK_HAUL) %>% 
  mutate(catch = (EST_COMBINED_WT/NUM_HOOK_HAUL)*1000) %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(catch))
  
ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line(alpha=0.3)+
  theme_bw()+
  geom_point(aes(y=rollmean(CPUE, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(CPUE, 3, na.pad = T)),
            col="blue")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = 'Mean catch (kg) per 1000 hooks')
```


### Snow Crab Otter Trawl Survey (Divs. 4VWX)

```{r snow-dist, message = FALSE, warning=FALSE, fig.cap="Distribution of Atlantic wolffish catches in the Snowcrab Fixed Survey (Divs. 4VWX), 2004-2021, summed by 15 minute aggregation."}

a <-snowcrab_null %>% select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50) 
null <- snowcrab_null %>%  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)

a <- Mar.utils::aggregator(a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15) 
null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15) 

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-66.5, -57), ylim = c(42.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=a, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  scale_size_continuous( breaks=c(5,10,20))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")

```

```{r snow-catch, message = FALSE, warning=FALSE, fig.cap="Mean catch per tow of Atlantic wolffish in the Snowcrab Fixed Survey (Divs. 4VWX), 2004-2021."}
cpue <- snowcrab %>% 
  filter(YEAR > 2004) %>% 
  filter(YEAR !=2020) %>% 
  filter(EST_COMBINED_WT>0.01) %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(EST_COMBINED_WT))
  
ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line(alpha=0.3)+
  theme_bw()+
  geom_point(aes(y=rollmean(CPUE, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(CPUE, 3, na.pad = T)),
            col="blue")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = 'Catch (kg) per tow')
```


### Lobster/ITQ Otter Trawl Survey (Div. 4X)

```{r lobQ-dist, message = FALSE, warning=FALSE, fig.cap="Distribution of Atlantic wolffish catches in the ITQ and Lobster surveys (Div. 4X), 1995-2021, summed by 15 minute aggregation."}
a <- ITQ_null %>% select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)

b <- lobster_null %>% select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)

null_a <- ITQ_null %>%  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)
null_b <- lobster_null %>%  select(YEAR, lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)

a <- Mar.utils::aggregator(a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
b <- Mar.utils::aggregator(b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15)
null_a <- Mar.utils::aggregator(null_a, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15) 
null_b <- Mar.utils::aggregator(null_b, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 15) 

a$survey <- "ITQ Survey, 1995-2012"
b$survey <- "ILTS Survey, 2013-2021"
df <- rbind(a,b)

null_a$survey <- "ITQ Survey, 1995-2012"
null_b$survey <- "ILTS Survey, 2013-2021"
df <- rbind(a,b)

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -63), ylim = c(42, 46), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.6, size=0.6)+
  geom_point(data=df, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  scale_size_continuous(breaks=c(5,50,250,500,750, 1000))+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Catch (kg/tow)")+
  facet_grid(cols=vars(factor(survey,levels=c("ITQ Survey, 1995-2012", "ILTS Survey, 2013-2021"))))
```

```{r lobQ-catch,  message = FALSE, warning=FALSE, fig.cap="Mean catch per tow of Atlantic wolffish in the ITQ and Lobster surveys (Div. 4X), 1995-2021."}
cpue <- lobQ %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(EST_COMBINED_WT))
  
ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line(alpha=0.3)+
  theme_bw()+
  geom_point(aes(y=rollmean(CPUE, 3, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(CPUE, 3, na.pad = T)),
            col="blue")+
  geom_vline(xintercept = 2012, col="red", linetype="dashed")+
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"))+
  labs(y = 'Mean catch per tow')
```


## Commercial Landings 

```{r landings, warning=FALSE, message = FALSE, fig.cap="Commercial landings from the Canadian Observer Program of wolffish from Divs. 4VW, 4X and 5Z."}
landings <- landings %>% 
  mutate(area=case_when(grepl('^4V|^4W', NAFO_AREA) ~ "4VW",
                        grepl('4X', NAFO_AREA) ~ "4X",
                        grepl('5Z', NAFO_AREA) ~ "5Z"))

df <- landings %>% 
  #filter(area%in%c("4VW", "4X", "5Z")) %>%
  group_by(YEAR) %>%
  summarise(landings = sum(RND_WEIGHT_KGS)*0.001)

landings %>% 
  filter(area%in%c("4VW", "4X", "5Z")) %>%
  group_by(YEAR, area) %>%
  summarise(landings = sum(RND_WEIGHT_KGS)*0.001) %>% 
  ggplot(aes(YEAR, landings, group=area)) +
  geom_point(aes(col=area))+
  geom_line(aes(col=area))+
  theme_bw()+
  theme(legend.title=element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"),
        axis.title.x = element_blank())+
  labs(y = 'Landings (t)')
```

```{r landings-dist, warning=FALSE, message = FALSE, fig.cap="Distribution of commercial landings from the Canadian Observer Program of wolffish from Divs. 4VW, 4X and 5Z."}
a <- landings %>%
  filter(area%in%c("4VW", "4X", "5Z")) %>%
  mutate(weight=RND_WEIGHT_KGS*0.001)

a <- Mar.utils::aggregator(a, lat.field = "lat", lon.field = "long", agg.fields = "weight", agg.minutes = 10) 

autoplot(bathy, geom = c("r", "c"), colour = "gray57", size = 0.1) +
  scale_fill_gradientn(limits = c(-6600, 0), colors = c("steelblue4", "#C7E0FF"))+
  geom_contour(aes(z=z),
               breaks=c(0, -100, -200), colour="gray57", size=0.2)+
  coord_sf(xlim = c(-68, -57), ylim = c(41.5, 47.5), expand = FALSE)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),size=0.5,fill=NA,col="black")+
  geom_point(data=a, aes(x=long, y=lat, size=weight_SUM), alpha = 1)+
  scale_size_continuous( breaks=c(5,25,50,75))+
   geom_polygon(data=canada,
               aes(long, lat, group = group),lwd=0.5,fill="#757474",col="black")+
    geom_polygon(data=usa,
               aes(long, lat, group = group),lwd=0.5,fill="#757474",col="black")+
  theme_bw()+
  guides(fill = "none")+
  theme(axis.title = element_blank(),
        axis.text = element_text(size=9),
        legend.position="bottom")+
  labs(size = "Total Rounded Weight (t)")
```

```{r, warning=FALSE, message = FALSE, fig.cap="Proportion of total Atlantic wolffish catches (weight) by trip from Commercial Sets and Industry Surveys in 4VXW.", fig.align='center'}
library(RColorBrewer)

catch <- isdb %>%
  filter(SETCD_ID %in%c(1, 10)) %>% 
  filter(grepl("^4", NAFAREA_ID)) %>%
  select(YEAR, EST_COMBINED_WT, EST_DISCARD_WT, EST_KEPT_WT) %>% 
  group_by(YEAR) %>%
  replace(is.na(.), 0) %>%
  summarize(discarded = sum(EST_DISCARD_WT)*0.001, 
            kept = sum(EST_KEPT_WT)*0.001)

catch <- pivot_longer(catch, 
                      discarded:kept,
                     names_to = 'catch', 
                     values_to = 'value')

catch %>%
  ggplot(aes(x=YEAR, y=value, fill=catch)) + 
  geom_bar(position="stack", stat="identity") +
  theme_bw()+
  theme(legend.title=element_blank(),
        axis.text = element_text(size=9),
        axis.title = element_text(size=11, face = "bold"),
        axis.title.x = element_blank())+
  scale_fill_brewer(palette="Paired")+
  labs(y = 'Wolffish catch (t)')

ggsave("discards.png", dpi=300)
```


