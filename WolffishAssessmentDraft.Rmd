---
title: "Atlantic Wolffish Post-COSEWIC Assessment"
authors: "Elizabetha Tsitrin, Kayla Silver, Daphne Themelis"
date: "`r format(Sys.Date(), format='%B %d %Y')`"  
---
  
**Purpose:** Provide an assessment of Atlantic Wolffish population trends in the Maritimes Region (Scotian Shelf) to inform the existing Recovery Strategy and Management Plan, and help guide future management actions and prioritize conservation measures. Externally, this information could support the next re-assessment of the species by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC).

**Background:** Atlantic Wolffish (*Anarhichas lupus*) underwent steep declines in both abundance and area of occupancy over much of its range from the 1980s until the mid 1990s. The species has been designated as Special Concern since 2000, with a re-evaluation in 2012 confirming the status. Research vessel surveys (NAFO areas 4X & 4VW) suggest that abundance continued to decline on the Scotian Shelf in the 2000s and remains at low levels. However, numerous factors make it difficult to confidently assess trends within the population. Using a combination of Fisheries Observer data, industry data, and Canadian Research Survey data, this review summarizes the current state of knowledge on the Atlantic Wolffish population trends in the Maritimes Region.

**Request for Science Advice:** Is it possible to develop a reliable biomass index for the Scotian Shelf portion of the population? Can the index be used to understand population trends over time? Can the index be used to assess and track fishing mortality over time? What does the data reveal about species distribution patterns? What does the data reveal about potential drivers of population decline, range shifts, and/or sustained low abundances?



```{r, echo=F, warning=F, message=F}
knitr::opts_chunk$set(echo = F, message=F, warning=F, error = F, prompt = F, results='asis')
```


```{r, include = FALSE}
#Set working directory and load libraries
setwd("C:/Users/TSITRINL/Documents/SARA/Wolffish/Data")
data.dir="C:/DFO-MPO/MarDataWrangling/wrangledData"

library(Mar.datawrangling)
library(gridExtra)
library(tidyverse)

# RV Database -------------------------------------------------------------
# import and clean data 
spring4VsW <- read.csv("spring4VsW.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4VsW_lengths <- read.csv("spring4VsW_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
spring4VsW_null <- read.csv("spring4VsW_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
spring4X <- read.csv("spring4X.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4x_lengths <- read.csv("spring4x_lengths.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  select(-X)
spring4X_null <- read.csv("spring4X_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
georges <- read.csv("georges.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
georges_lengths <- read.csv("georges_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
georges_null <- read.csv("georges_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1980) %>% 
  select(-X)
spring <- read.csv("spring.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
spring_lengths <- read.csv("spring_lengths.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
spring_null <- read.csv("spring_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR !=1995) %>% 
  select(-X)
summer <- read.csv("summer.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
summer_lengths <- read.csv("summer_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
summer_null <- read.csv("summer_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  select(-X)
fall <- read.csv("fall.csv", header = T) %>%
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
fall_lengths <- read.csv("fall_lengths.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
fall_null <- read.csv("fall_null.csv", header = T) %>% 
  filter(TYPE == 1) %>% 
  filter(YEAR != 1986) %>% 
  select(-X)
redfish <- read.csv("redfish.csv", header = T) %>%
  select(-X)
redfish_lengths <- read.csv("redfish_lengths.csv", header = T) %>% 
  select(-X)
redfish_null <- read.csv("redfish_null.csv", header = T) %>% 
  select(-X)

```



# Research Vessel Surveys
### Distribution of Wolffish in RV Surveys
```{r, include = FALSE}
library(sp)
library(rgdal)
library(mapdata)
library(marmap)
library(maptools)


NAFODivisions <- rgdal::readOGR(dsn="Divisions.shp")
NAFODivisions <- spTransform(NAFODivisions,CRS("+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"))

states <- map_data("state")
usa <- subset(states,region == "maine")
canada <- map_data("worldHires", "Canada")
FortNAFO <- fortify(NAFODivisions)


bathy <- getNOAA.bathy(-50, -80, 35, 48, resolution=1, antimeridian = F, keep=T)
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the 4VsW RV Survey, 1986-2010, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
# 4VsW null vs wolffish catches

null <- spring4VsW_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)
wolf <-spring4VsW_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
    filter(TOTWGT > 0) %>% 
  filter(CODE == 50)

null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-63.5, -56.5),
    ylim = c(42.5, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the 4VsW RV Survey, 1986-2010, summed by 5 minute aggregation.", fig.align='center', fig.height = 7}
mature <- spring4VsW_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN > 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
mature <- as.data.frame(mature)

immature <- spring4VsW_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN <= 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
immature <- as.data.frame(immature)

null <- spring4VsW_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)


mature <- Mar.utils::aggregator(mature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
immature <- Mar.utils::aggregator(immature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5)

a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-63.5, -56.5),
    ylim = c(42.5, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=immature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish 1-53 cm")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-63.5, -56.5),
    ylim = c(42.5, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=mature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  scale_size(breaks = c(2,4,6))+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish >53 cm")

ggpubr::ggarrange(a,b, nrow=2)
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the 4X RV Survey, 2012-2020, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
# 4x null vs wolffish catches
null <- spring4X_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)
wolf <-spring4X_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE == 50)

null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -62),
    ylim = c(42, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the 4X RV Survey, 2012-2020, summed by 5 minute aggregation.", fig.align='center', fig.height = 7}
mature <- spring4x_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN > 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
mature <- as.data.frame(mature)

immature <- spring4x_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN <= 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
immature <- as.data.frame(immature)

null <- spring4X_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)


mature <- Mar.utils::aggregator(mature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
immature <- Mar.utils::aggregator(immature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5)

a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -62),
    ylim = c(42, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=immature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish 1-53 cm")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -62),
    ylim = c(42, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=mature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  scale_size(range= c(1,2))+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish >53 cm")

ggpubr::ggarrange(a,b, nrow=2)
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Spring RV Survey, 1979-1985, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
# spring null vs wolffish catches
null <- spring_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)
wolf <-spring_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(TOTWGT >0) %>% 
  filter(CODE == 50)

null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(42, 46.5))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")

```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Summer RV Survey, 1970-2021, summed by 15 minute aggregation.", fig.align='center', fig.height = 7}
null_a <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR < 2011) %>% 
  filter(CODE != 50)
wolf_a <-summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR < 2011) %>% 
  filter(CODE == 50)
null_b <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR > 2010) %>% 
  filter(CODE != 50)
wolf_b <-summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR > 2010) %>% 
  filter(TOTWGT > 0) %>% 
  filter(CODE == 50)


null_a <- Mar.utils::aggregator(null_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15) 
wolf_a <- Mar.utils::aggregator(wolf_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15) 
null_b <- Mar.utils::aggregator(null_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15) 
wolf_b <- Mar.utils::aggregator(wolf_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15) 


a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(41.5, 47.5))+
  geom_point(data=null_a, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf_a, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  scale_size(breaks = c(40,80,120,160,200))+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")+
  ggtitle("1970-2010")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(41.5, 47.5))+
  geom_point(data=null_b, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf_b, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")+
  ggtitle("2011-2021")

ggpubr::ggarrange(a,b, nrow=2)
```

```{r, fig.cap="Distribution of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the Summer RV Survey, 1970-2021, summed by 15 minute aggregation.", fig.align='center', fig.height = 7}
mature <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN > 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
mature <- as.data.frame(mature)

immature <- summer_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN <= 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
immature <- as.data.frame(immature)

null <- summer_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)


mature <- Mar.utils::aggregator(mature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15) 
immature <- Mar.utils::aggregator(immature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 15) 
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 15)

a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(41.5, 47.5))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=immature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish 1-53 cm")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(41.5, 47.5))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=mature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish >53 cm")

ggpubr::ggarrange(a,b, nrow=2)
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Fall RV Survey, 1978-1984, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
# fall null vs wolffish catches
null <- fall_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)
wolf <-fall_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(TOTWGT > 0) %>% 
  filter(CODE == 50)

null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -57),
    ylim = c(42, 47))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Redfish RV Survey, 1982-1988, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
null <- redfish_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)
wolf <-redfish_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(TOTWGT >0) %>% 
  filter(CODE == 50)

null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-66, -56.5),
    ylim = c(41.5, 46))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")

```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Georges Bank RV Survey, 1987-2021, summed by 5 minute aggregation.", fig.align='center', fig.height = 7}
# georges null vs wolffish catches
null_a <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR < 2011) %>% 
  filter(CODE != 50)
wolf_a <-georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR < 2011) %>%
  filter(TOTWGT > 0) %>% 
  filter(CODE == 50)
null_b <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR > 2010) %>% 
  filter(CODE != 50)
wolf_b <-georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT, YEAR) %>% 
  filter(YEAR > 2010) %>% 
  filter(TOTWGT > 0) %>% 
  filter(CODE == 50)


null_a <- Mar.utils::aggregator(null_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf_a <- Mar.utils::aggregator(wolf_a, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
null_b <- Mar.utils::aggregator(null_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 
wolf_b <- Mar.utils::aggregator(wolf_b, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5) 


a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-70, -65.7),
    ylim = c(40, 42.5))+
  geom_point(data=null_a, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf_a, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")+
  ggtitle("1987-2010")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-70, -65.7),
    ylim = c(40, 42.5))+
  geom_point(data=null_b, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf_b, aes(x=LONGITUDE, y=LATITUDE, size=TOTWGT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")+
  ggtitle("2011-2021")

ggpubr::ggarrange(a,b, nrow=2)
```

```{r, fig.cap="Distribution of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the Georges Bank RV Survey, 1987-2021, summed by 5 minute aggregation.", fig.align='center', fig.height = 7}
mature <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN > 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
mature <- as.data.frame(mature)

immature <- georges_lengths %>% select(LATITUDE, LONGITUDE, MISSION, SETNO, FLEN) %>% 
  filter(FLEN <= 53) %>% 
  group_by(MISSION, SETNO) %>% 
  mutate(count = length(FLEN)) %>% 
  ungroup() %>% 
  select(-FLEN) %>% 
  distinct(MISSION, SETNO, .keep_all=T)
immature <- as.data.frame(immature)

null <- georges_null %>% select(LATITUDE, LONGITUDE, CODE, TOTWGT) %>% 
  filter(CODE != 50)


mature <- Mar.utils::aggregator(mature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
immature <- Mar.utils::aggregator(immature, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "count", agg.minutes = 5) 
null <- Mar.utils::aggregator(null, lat.field = "LATITUDE", lon.field = "LONGITUDE", agg.fields = "TOTWGT", agg.minutes = 5)

a <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-70, -65.7),
    ylim = c(40, 42.5))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=immature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish 1-53 cm")

b <- ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-70, -65.7),
    ylim = c(40, 42.5))+
  geom_point(data=null, aes(x=LONGITUDE, y=LATITUDE), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=mature, aes(x=LONGITUDE, y=LATITUDE, size=count_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Number at length", x = "Latitude", y = "Longitude", title="Atlantic wolffish >53 cm")

ggpubr::ggarrange(a,b, nrow=2)
```
=


### Abundance of Wolffish in RV Surveys
```{r, include = FALSE}
#setup data for summaries - this chunk will be hidden

#GROUP ALL DATA
spring4VsW$SURVEY <- "4VsW"
spring4X$SURVEY <- "4X"
georges$SURVEY <- "Georges Bank"
spring$SURVEY <- "Spring"
summer$SURVEY <- "Summer"
fall$SURVEY <- "Fall"
redfish$SURVEY <- "Redfish"

a <- spring4VsW %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

b <- spring4X %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

c <- georges %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

d <- spring %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

e <- summer %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

f <- fall %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

g <- redfish %>% 
  filter(XTYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)


rv <- rbind(a,b,c,d,e,f,g)



#full nulls
spring4VsW_null$SURVEY <- "4VsW"
spring4X_null$SURVEY <- "4X"
georges_null$SURVEY <- "Georges Bank"
spring_null$SURVEY <- "Spring"
summer_null$SURVEY <- "Summer"
fall_null$SURVEY <- "Fall"
redfish_null$SURVEY <- "Redfish"


a <- spring4VsW_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

b <- spring4X_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

c <- georges_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

d <- spring_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

e <- summer_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

f <- fall_null %>% 
  filter(TYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)

g <- redfish_null %>% 
  filter(XTYPE == 1) %>% 
  select(YEAR, MISSION, SETNO, SDATE, lat = LATITUDE, long = LONGITUDE, STRAT, AREA, GEAR, DUR, DIST, SPEED, SAMPWGT, TOTWGT, TOTNO, SURVEY)


rv_null <- rbind(a,b,c,d,e,f,g)



#Annual
rv_summary <- rv %>% 
  group_by(SURVEY, YEAR) %>% 
  summarise(sets = length(unique(SETNO)))

rv_null_summary <- rv_null %>%
  group_by(SURVEY, YEAR) %>% 
  summarise(nullsets = length(unique(SETNO)))

rv_summary <- left_join(rv_summary, rv_null_summary, by=c("SURVEY", "YEAR")) %>% 
  mutate(occurance = 100*(sets/nullsets))

```
      
```{r, fig.cap="Percent occurance of wolffish in survey sets", fig.align='center'}
ggplot(rv_summary, aes(YEAR, occurance, colour=SURVEY))+
  geom_line()+
  theme_classic()+
  facet_wrap(~SURVEY, scales = "free_x")

```
  
```{r, fig.cap="Stratified biomass of Atlantic wolffish in the 4VsW RV Survey, 1986-2010, with five-year running mean (blue).", fig.align='center'}
strat <- spring4VsW_null %>% 
  filter(STRAT %in%(397:411)) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

catch <- spring4VsW %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(weight = sum(TOTWGT/standard_dist),
            wolfsets = length(unique(SETNO)))

area <- spring4VsW_null %>% 
  filter(STRAT %in%(397:411)) %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(catch, by=c('YEAR', 'STRAT')) %>% 
  mutate(biomass = (weight/numsets)*swept) %>% 
  mutate(occurance = (wolfsets/numsets)*100) %>% 
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>% 
  replace(is.na(.), 0)

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(biomass = sum(biomass)*0.001,
            total_area = sum(AREA.GSSTRATUM),
            area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100,
            occurance = mean(occurance))

library(zoo)
ggplot(total, aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(alpha=0.3)+
  # geom_smooth(method = "loess", se = F)+
  geom_point(aes(y=rollmean(biomass, 5, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(biomass, 5, na.pad = T)),
            col="blue")+
  theme_classic()+
  labs(x = "Year", y = "Biomass (tonnes)")
```

```{r, fig.cap="Stratified abundance of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the 4VsW RV Survey, 1986-2010, with five-year running means.", fig.align='center'}
abun <- spring4VsW_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()

totalm <- total %>% filter(maturity=="mature")
totali <- total %>% filter(maturity=="immature")

ggplot(total, aes(x=YEAR, y=abundance, shape=maturity))+
  geom_point()+
  geom_line(alpha=0.3)+
  # geom_smooth(method = "loess", se = F)+
  geom_point(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="#00D712")+
  geom_line(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "#00D712", size=1)+
    geom_point(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="blue")+
  geom_line(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "blue", size=1)+
  theme_classic()+
  guides(shape = guide_legend(override.aes = list(color = c("blue", "#00D712"))))+
  scale_y_continuous(labels=scales::comma)+
  labs(x = "Year", y = "Number at Length")
```
  
```{r, fig.cap="Stratified biomass of Atlantic wolffish in the 4X RV Survey, 2012-2020, with two-year running mean (blue).", fig.align='center'}
strat <- spring4X_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

catch <- spring4X %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(weight = sum(TOTWGT/standard_dist),
            wolfsets = length(unique(SETNO)))

area <- spring4X_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(catch, by=c('YEAR', 'STRAT')) %>% 
  mutate(biomass = (weight/numsets)*swept) %>% 
  mutate(occurance = (wolfsets/numsets)*100) %>% 
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>% 
  replace(is.na(.), 0)

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(biomass = sum(biomass)*0.001,
            total_area = sum(AREA.GSSTRATUM),
            area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100,
            occurance = mean(occurance))

ggplot(total, aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(alpha=0.3)+
  geom_point(aes(y=rollmean(biomass, 2, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(biomass, 2, na.pad = T)),
            col="blue")+
  theme_classic()+
  labs(x = "Year", y = "Biomass (tonnes)")
```

```{r, fig.cap="Stratified abundance of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the 4X RV Survey, 2012-2020, with two-year running means.", fig.align='center'}
abun <- spring4x_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()

totalm <- total %>% filter(maturity=="mature")
totali <- total %>% filter(maturity=="immature")

ggplot(total, aes(x=YEAR, y=abundance, shape=maturity))+
  geom_point()+
  geom_line(alpha=0.3)+
  geom_point(data=totalm, aes(y=rollmean(abundance, 2, na.pad = T)),
             size=2, color="#00D712")+
  geom_line(data=totalm, aes(y=rollmean(abundance, 2, na.pad = T)),
            color = "#00D712", size=1)+
    geom_point(data=totali, aes(y=rollmean(abundance, 2, na.pad = T)),
             size=2, color="blue")+
  geom_line(data=totali, aes(y=rollmean(abundance, 2, na.pad = T)),
            color = "blue", size=1)+
  theme_classic()+
  guides(shape = guide_legend(override.aes = list(color = c("blue", "#00D712"))))+
  scale_y_continuous(labels=scales::comma)+
  labs(x = "Year", y = "Number at Length")
```
  
```{r, fig.cap="Stratified biomass of Atlantic wolffish in the Summer RV Survey, 1970-2021, with five-year running mean (blue).", fig.align='center'}
strat <- summer_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

catch <- summer %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(weight = sum(TOTWGT/standard_dist),
            wolfsets = length(unique(SETNO)))

area <- summer_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(catch, by=c('YEAR', 'STRAT')) %>% 
  mutate(biomass = (weight/numsets)*swept) %>% 
  mutate(occurance = (wolfsets/numsets)*100) %>% 
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>% 
  replace(is.na(.), 0)

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(biomass = sum(biomass)*0.001,
            total_area = sum(AREA.GSSTRATUM),
            area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100,
            occurance = mean(occurance))

ggplot(total, aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(alpha=0.3)+
  #geom_smooth(method = "loess", se = F)+
  geom_point(aes(y=rollmean(biomass, 5, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(biomass, 5, na.pad = T)),
            col="blue")+
  theme_classic()+
  labs(x = "Year", y = "Biomass (tonnes)")
```

```{r, fig.cap="Stratified abundance of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the Summer RV Survey, 1970-2021, with five-year running means.", fig.align='center'}
abun <- summer_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()

totalm <- total %>% filter(maturity=="mature")
totali <- total %>% filter(maturity=="immature")

ggplot(total, aes(x=YEAR, y=abundance, shape=maturity))+
  geom_point()+
  geom_line(alpha=0.3)+
  # geom_smooth(method = "loess", se = F)+
  geom_point(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="#00D712")+
  geom_line(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "#00D712", size=1)+
    geom_point(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="blue")+
  geom_line(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "blue", size=1)+
  theme_classic()+
  guides(shape = guide_legend(override.aes = list(color = c("blue", "#00D712"))))+
  scale_y_continuous(labels=scales::comma)+
  labs(x = "Year", y = "Number at Length")
```

```{r, fig.cap="Stratified biomass of Atlantic wolffish in the Georges Bank RV Survey, 1987-2021, with five-year running mean (blue).", fig.align='center'}
strat <- georges_null %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

catch <- georges %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(weight = sum(TOTWGT/standard_dist),
            wolfsets = length(unique(SETNO)))

area <- georges_null %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(catch, by=c('YEAR', 'STRAT')) %>% 
  mutate(biomass = (weight/numsets)*swept) %>% 
  mutate(occurance = (wolfsets/numsets)*100) %>% 
  mutate(area_occupied = (wolfsets/numsets)*AREA.GSSTRATUM) %>% 
  replace(is.na(.), 0)

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(biomass = sum(biomass)*0.001,
            total_area = sum(AREA.GSSTRATUM),
            area_occupied = sum(area_occupied),
            percent_area = (area_occupied/total_area)*100,
            occurance = mean(occurance))

ggplot(total, aes(x=YEAR, y=biomass))+
  geom_point()+
  geom_line(alpha=0.3)+
  #geom_smooth(method = "loess", se = F)+
  geom_point(aes(y=rollmean(biomass, 5, na.pad = T)),
             col="blue", size=2)+
  geom_line(aes(y=rollmean(biomass, 5, na.pad = T)),
            col="blue")+
  theme_classic()+
  labs(x = "Year", y = "Biomass (tonnes)")
```

```{r, fig.cap="Stratified abundance of immature (<53 cm) and mature (>53 cm) Atlantic wolffish in the Georges Bank RV Survey, 1987-2021, with five-year running means.", fig.align='center'}
abun <- georges_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()

totalm <- total %>% filter(maturity=="mature")
totali <- total %>% filter(maturity=="immature")

ggplot(total, aes(x=YEAR, y=abundance, shape=maturity))+
  geom_point()+
  geom_line(alpha=0.3)+
  # geom_smooth(method = "loess", se = F)+
  geom_point(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="#00D712")+
  geom_line(data=totalm, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "#00D712", size=1)+
    geom_point(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
             size=2, color="blue")+
  geom_line(data=totali, aes(y=rollmean(abundance, 5, na.pad = T)),
            color = "blue", size=1)+
  theme_classic()+
  guides(shape = guide_legend(override.aes = list(color = c("blue", "#00D712"))))+
  scale_y_continuous(labels=scales::comma)+
  labs(x = "Year", y = "Number at Length")
```


### Length Frequency and Catch Rate
```{r, fig.cap="Length Frequency distributions of wolffish from RV surveys", fig.align='center'}
#SPRING 4VSW
j <- spring4VsW_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("SPRING 4VsW")+
  theme(plot.title = element_text(size = 12))

#SPRING 4X
k<- spring4x_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("SPRING 4X")+
  theme(plot.title = element_text(size = 12))

#SPRING
l <- spring_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("SPRING")+
  theme(plot.title = element_text(size = 12))

#GEORGES 
m <- georges_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("GEORGES BANK (5Z)")+
  theme(plot.title = element_text(size = 12))

#FALL
n <- fall_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("FALL")+
  theme(plot.title = element_text(size = 12))

#SUMMER 
o <- summer_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("SUMMER")+
  theme(plot.title = element_text(size = 12))

#REDFISH 
p <- redfish_lengths %>% 
  ggplot(aes(FLEN))+
  geom_histogram(binwidth = 5, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("REDFISH")+
  theme(plot.title = element_text(size = 12))

gridExtra::grid.arrange(j,k,l,m,n,o,p, nrow = 2)
```
  
```{r, fig.cap="Log Transformed catch rate (total number at length) for  RV survey", fig.align='center'}
#Spring_4x
strat <- spring4X_null %>% 
  filter(YEAR > 2008) %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

area <- spring4X_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

abun <- spring4x_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total_mat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="mature")

total_immat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="immature")

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()


a <- ggplot(total_immat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Spring 4X immature")


b <- ggplot(total_mat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Spring 4X mature")

c <- ggplot(total, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Spring 4X total")


#Summer
strat <- summer_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

area <- summer_null %>% 
  filter(STRAT %in%(440:495)) %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

abun <- summer_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total_mat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="mature")

total_immat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="immature")

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()


d <- ggplot(total_immat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Summer immature")


e <- ggplot(total_mat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Summer mature")

f <- ggplot(total, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Summer total")


#George's
strat <- georges_null %>% 
  group_by(YEAR, STRAT) %>% 
  summarize(numsets = length(unique(SETNO)))

area <- georges_null %>% 
  group_by(STRAT) %>% 
  distinct(AREA.GSSTRATUM) %>% 
  mutate(swept = AREA.GSSTRATUM/0.0118006)

abun <- georges_lengths %>% 
  mutate(maturity = ifelse(FLEN > 53, "mature", "immature")) %>% 
  mutate(standard_dist = DIST/1.75) %>% 
  group_by(YEAR, STRAT, maturity) %>% 
  summarize(count = sum(length(FLEN)/standard_dist))

summary_strat <- strat %>% left_join(area, by="STRAT") %>% 
  left_join(abun, by=c('YEAR', 'STRAT')) %>% 
  mutate(count = ifelse(is.na(count), 0, count)) %>% 
  mutate(abundance = (count/numsets)*swept) 

total_mat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="mature")

total_immat <- summary_strat%>% 
  group_by(YEAR, maturity) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na() %>% 
  filter(maturity=="immature")

total <- summary_strat%>% 
  group_by(YEAR) %>% 
  summarise(abundance = sum(abundance)) %>% 
  drop_na()


g <- ggplot(total_immat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Georges immature")


h <- ggplot(total_mat, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Georges mature")

i <- ggplot(total, aes (YEAR, log(abundance))) +
  geom_point(color = 'blue') +
  geom_smooth(method = 'lm', se = FALSE, color = 'black') +
  theme_classic() +
  labs(x="Year", y="Log (count)", title="Geores total")

gridExtra::grid.arrange(a,b,c,d,e,f,g,h,i, nrow=3, ncol = 3)
```
  


# Industry Surveys
```{r, include = FALSE}
#import and clean data, this chunk will be hidden
isdb <- read.csv("isdb.csv", header = T) %>%
  select(-X)
isdb_lengths <- read.csv("isdb_lengths.csv", header = T) %>%
  select(-X)
isdb_null <- read.csv("isdb_null.csv", header = T) %>%
  select(-X)


#Halibut Industry Longline Survey
halibut_longline <- isdb %>% filter(TRIPCD_ID == 7057)
unique(halibut_longline$SET_TYPE)

halibut_longline %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

halibut_fixed <- halibut_longline %>% 
  filter(SETCD_ID == 4)


#4VSW Sentinel Survey
sentinel <- isdb %>% filter(TRIPCD_ID == 7050)
unique(sentinel$SET_TYPE)

sentinel %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

sentinel <- sentinel %>% 
  filter(SETCD_ID == 5)

                     
#ITQ
ITQ <- isdb %>% filter(TRIPCD_ID == 7051)
unique(ITQ$SET_TYPE)

ITQ %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

ITQ <- ITQ %>% 
  filter(SETCD_ID == 4)


#LOBSTER
lobster <- isdb %>% filter(TRIPCD_ID == 7065)
unique(lobster$SET_TYPE)


#combine
lobQ <- rbind(ITQ, lobster)


#SNOWCRAB
snowcrab <- isdb %>% filter(TRIPCD_ID == 7061)
unique(snowcrab$SET_TYPE)

snowcrab %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

snowcrab <- snowcrab %>% 
  filter(SETCD_ID == 4)




#NULL SURVEYS
#Halibut Industry Longline Survey
halibut_longline_null <- isdb_null %>% filter(TRIPCD_ID == 7057)
unique(halibut_longline_null$SET_TYPE)

halibut_longline_null %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

halibut_fixed_null <- halibut_longline_null %>% 
  filter(SETCD_ID == 4)

unique(halibut_fixed_null$SET_TYPE)


#4VSW Setinel Survey
sentinel_null <- isdb_null %>% filter(TRIPCD_ID == 7050)
unique(sentinel_null$SET_TYPE)

sentinel_null %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

sentinel_null <- sentinel_null %>% 
  filter(SETCD_ID == 5)


#ITQ
ITQ_null <- isdb_null %>% filter(TRIPCD_ID == 7051)
unique(ITQ_null$SET_TYPE)

ITQ_null %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

ITQ_null <- ITQ_null %>% 
  filter(SETCD_ID == 4)


#LOBSTER
lobster_null <- isdb_null %>% filter(TRIPCD_ID == 7065)
unique(lobster_null$SET_TYPE)

lobster_null %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

lobster_null <- lobster_null %>% 
  filter(SETCD_ID == 4)

#combine
lobQ_null <- rbind(ITQ_null, lobster_null)


#SNOWCRAB
snowcrab_null <- isdb_null %>% filter(TRIPCD_ID == 7061)
unique(snowcrab_null$SET_TYPE)

snowcrab_null %>% 
  group_by(SET_TYPE) %>% 
  summarize(trips = length(unique(FISHSET_ID)))

snowcrab_null <- snowcrab_null %>% 
  filter(SETCD_ID == 4)
```


### Distribution of Wolffish in Industry Surveys
```{r, fig.cap="Distribution of Atlantic wolffish catches in the Halibut Longline Survey, 1998-2021, summed by 10 minute aggregation.", fig.align='center', fig.height = 3}
null <- halibut_longline_null %>%  select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50) %>% 
  filter(grepl("^4|^5", NAFAREA_ID ))
wolf <-halibut_longline_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
    filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50) %>% 
  filter(grepl("^4|^5", NAFAREA_ID ))

null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 10) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 10) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -56),
    ylim = c(41, 47.8))+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the 4VSW Sentinel Survey, 1996-2020, summed by 10 minute aggregation.", fig.align='center', fig.height = 3}
null <- sentinel_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50) %>% 
  filter(grepl("^4|^5", NAFAREA_ID ))
wolf <-sentinel_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
    filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50) %>% 
  filter(grepl("^4|^5", NAFAREA_ID ))

null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 10) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 10) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-64.5, -57),
    ylim = c(42.5, 46))+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Lobster/ITQ Survey, 1995-2021, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
null <- lobQ_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)
wolf <-lobQ_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
    filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)

null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-68, -63),
    ylim = c(41.7, 46))+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Snowcrab Ecosystem Survey, 2004-2021, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
snow_eco_null <- read.csv("snow_eco_null.csv", header = T) %>%
  select(-X)

null <- snow_eco_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)
wolf <- snow_eco_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)

null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-61, -58),
    ylim = c(43, 47))+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  scale_size(breaks = c(1,2,3))+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

```{r, fig.cap="Distribution of Atlantic wolffish catches in the Snowcrab Fixed Survey, 2004-2021, summed by 5 minute aggregation.", fig.align='center', fig.height = 3}
null <- snowcrab_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
  filter(SPECCD_ID != 50)
wolf <-snowcrab_null %>% select(lat, long, SPECCD_ID, EST_COMBINED_WT, NAFAREA_ID) %>% 
    filter(EST_COMBINED_WT > 0) %>% 
  filter(SPECCD_ID == 50)

null <- Mar.utils::aggregator(null, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 
wolf <- Mar.utils::aggregator(wolf, lat.field = "lat", lon.field = "long", agg.fields = "EST_COMBINED_WT", agg.minutes = 5) 

ggplot(bathy, aes(x=x, y=y))+
  geom_raster(aes(fill=z)) +
  scale_fill_etopo() +
  geom_contour(aes(z=z),
               breaks=c(0, -200, -400, -800, -1200, -1600, -2000, -2400, -2800, -3200), colour="gray57", size=0.2)+
  geom_polygon(data=FortNAFO,
               aes(long, lat, group = group),lwd=0.5,fill=NA,col="black")+
  coord_cartesian(
    xlim = c(-66, -56.5),
    ylim = c(42.7, 47.3))+
  geom_point(data=null, aes(x=long, y=lat), shape=3, alpha = 0.7, size=0.6)+
  geom_point(data=wolf, aes(x=long, y=lat, size=EST_COMBINED_WT_SUM), alpha = 1)+
  theme_classic()+
  guides(fill = FALSE)+
  labs(size = "Catch (kg/tow)", x = "Latitude", y = "Longitude")
```

    
### Abundance of Wolffish in Industry Surveys
```{r, include=FALSE}
#setup data for summaries - this chunk will be hidden

a <- halibut_fixed_null %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
b <- sentinel_null %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
c <- ITQ_null %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
d <- lobster_null %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
e <- snowcrab_null %>% select(YEAR, TRIP_TYPE, FISHSET_ID)

sampled_null <- rbind(a,b,c,d,e)


f <- halibut_fixed %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
g <- sentinel %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
h <- ITQ %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
i <- lobster %>% select(YEAR, TRIP_TYPE, FISHSET_ID)
j <- snowcrab %>% select(YEAR, TRIP_TYPE, FISHSET_ID)

isb_surveys <- rbind(f,g,h,i,j)

#summarize sets
isdb_summary <- isb_surveys %>% 
  group_by(TRIP_TYPE, YEAR) %>% 
  summarise(sets = length(unique(FISHSET_ID)))

isdb_null_summary <- sampled_null %>% 
  group_by(TRIP_TYPE, YEAR) %>% 
  summarise(nullsets = length(unique(FISHSET_ID)))

isdb_summary <- left_join(isdb_summary, isdb_null_summary, by=c("TRIP_TYPE", "YEAR")) %>% 
  mutate(occurance = 100*(sets/nullsets))

```

```{r, fig.cap="Percent occurance of wolffish in survey sets", fig.align='center'}
ggplot(isdb_summary, aes(YEAR, occurance, colour=TRIP_TYPE))+
  geom_line()+
  theme_classic()+
  facet_wrap(~TRIP_TYPE, scales = "free_x")

```
  
  

### Wolffish Biomass in Industry Surveys
```{r, fig.cap="Length Frequency distributions of Atlantic wolffish in the Snowcrab Environmental Survey", fig.align='center'}
isdb_lengths %>% 
  filter(TRIPCD_ID == 7061) %>% 
  filter(SETCD_ID == 11) %>% 
  ggplot(aes(FISH_LENGTH))+
  geom_histogram(binwidth = 2, col="black", fill="black", alpha=.2)+
  labs(y="Frequency (count)", x='Length (cm)')+
  theme_classic()+
  ggtitle("Snowcrab Ecosystem Survey")+
  theme(plot.title = element_text(size = 12))
```

```{r, fig.cap="Catch per Unit Effort of Atlantic wolffish in the Halibut Longline Survey", fig.align='center'}
cpue <- halibut_longline %>% 
  #filter(HOOKCD_ID == 141) %>% 
  select(YEAR, EST_COMBINED_WT, NUM_HOOK_HAUL) %>% 
  mutate(sum = (EST_COMBINED_WT/NUM_HOOK_HAUL)*1000) %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(sum))
  
ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(title = "Halibut Longline Survey CPUE",
       x = 'Year',
       y = 'Mean Catch (kg) per 1000 hooks')
```
  
```{r, fig.cap="Catch per Unit Effort of Atlantic wolffish in the 4VSW Sentinel Longline Survey", fig.align='center'}
pue <- sentinel %>% 
  select(YEAR, EST_COMBINED_WT, NUM_HOOK_HAUL) %>% 
  mutate(sum = (EST_COMBINED_WT/NUM_HOOK_HAUL)*1000) %>% 
  group_by(YEAR) %>%   
  summarise(CPUE = mean(sum))


ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(title = "Sentinel Longline Survey CPUE",
       x = 'Year',
       y = 'CPUE (kg/1000 hooks)')
```

```{r, fig.cap="Catch per tow of Atlantic wolffish in the ITQ/Lobster Survey", fig.align='center'}
a <- ITQ %>%  select(YEAR, EST_COMBINED_WT) %>% 
  mutate(survey="ITQ")

b <- lobster %>%  select(YEAR, EST_COMBINED_WT) %>% 
  mutate(survey="Lobster")

cpue <- rbind(a,b) %>% 
  group_by(YEAR) %>% 
  summarise(CPUE = mean(EST_COMBINED_WT))

ggplot(cpue, aes(YEAR, CPUE))+
  geom_point()+
  geom_line()+
  theme_classic()+
  geom_vline(xintercept = 2012, col="blue", linetype="dashed")+
  labs(title = "ITQ/Lobster Surveys Uncorrected Catch per tow",
       x = 'Year',
       y = 'Catch (kg/tow)')
```
  






